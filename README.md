# HH Bot

Телеграм‑бот, который ищет вакансии на hh.ru, сохраняет результаты, шлёт подборки по расписанию и умеет генерировать резюме/cover letter через совместимый с OpenAI LLM.

## Что умеет

- Базовые команды: `/start`, `/help`, `/profile`, `/preferences`, `/search`, `/search_settings`, `/resume`, `/location`, `/vacancy_schedule`, `/vacancy_schedule_test`.
- Профиль и данные пользователя: Telegram ID/username/имя, язык интерфейса (ru/en), город с HH area id, желаемая позиция, навыки, базовое резюме, индивидуальные настройки LLM (модель, base URL, API key не хранится в README).
- Поиск по hh.ru: запрос текстом или через `/search <запрос>`, поддерживаются фильтры (город, минимальная зарплата, только удалёнка, свежесть, тип занятости, опыт). Если команда без текста — показывает последние сохранённые результаты.
- Карточки и детали вакансии: пагинация, просмотр полной карточки, кнопка открытия на hh.ru.
- Генерация документов: CV и сопроводительное письмо по вакансии с учётом резюме/скиллов пользователя; кэширование с возможностью переслать или регенерировать; можно использовать глобальный LLM из `.env` или пользовательский (модель/base URL/key) из профиля.
- Ежедневные подборки: APScheduler раз в минуту проверяет время, отправляет новые вакансии по последнему поисковому запросу с учётом фильтров/города, не дублирует уже отправленные id; поддерживается выбор часового пояса и тестовая отправка.
- Локализация: ответы и кнопки на русском и английском (i18n файлы в `i18n/ru`, `i18n/en`).
- Логи: Loguru с выводом в stdout и ротацией файлов в `logs/`.

## Архитектура

- `main.py` — запуск aiogram‑бота, подключение к базе, подготовка клиентов hh.ru и LLM, старт планировщика.
- `bot/config.py` — настройки через pydantic settings.
- Хранилище: PostgreSQL (asyncpg + SQLAlchemy). Таблицы `users`, `search_queries`, `vacancies`, `user_search_results`, `cv`.
- Репозитории в `bot/db/*repository.py`, сервисы в `bot/services` (hh_api, openai, users, search, cv), обработчики aiogram в `bot/handlers`.
- Планировщик: `bot/utils/scheduler.py` + job `bot/tasks/vacancy_delivery.py`.

## Настройка окружения

1) Требования: Python 3.11+, PostgreSQL (Neon совместим), Telegram Bot API токен, при использовании генерации — ключ к совместимому с OpenAI API.
2) Создайте `.env` в корне (значения подставьте свои, ключи в репозиторий не коммитить):
```
TG_BOT_API_KEY=telegram_bot_token
DATABASE_URL=postgres://user:pass@host/dbname?sslmode=require
LLM_API_KEY=optional_llm_key
LLM_API_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4o-mini
LOG_LEVEL=INFO
ENV=dev
# Webhook (используется только при ENV=prod)
WEBHOOK_URL=https://bender.pavelveter.com/hh-bot
WEBHOOK_SECRET=change-me
WEBAPP_HOST=0.0.0.0
WEBAPP_PORT=8271
```
   URL к базе можно задавать в формате `postgres://...` — драйвер автоматически конвертируется в `postgresql+asyncpg://` и прокидывает SSL‑параметры.
3) Установите зависимости через [uv](https://github.com/astral-sh/uv):
```
uv sync
```
4) Примените миграции:
```
uv run alembic upgrade head
```
5) Запустите бота:
```
uv run python main.py
```

## Как пользоваться

- Зайти в бот → `/start` создаёт профиль и подбирает язык. `/help` показывает шпаргалку.
- `/location <город>` — сохраняет город и HH area id. Повторный вызов без параметров покажет текущие данные, команды clear/удалить сбрасывают.
- Настройка профиля и фильтров через `/profile`, `/preferences`, `/search_settings` и инлайн‑кнопки: имя/город/позиция, навыки, резюме, фильтры поиска (зарплата, удалёнка, свежесть, занятость, опыт), LLM overrides (модель/base URL/key хранятся в preferences и не попадают в README).
- Поиск — текстом или `/search <запрос>`, выдача с пагинацией; без текста показывает последние сохранённые результаты.
- В карточке вакансии доступны кнопки генерации/повторной отправки CV или cover letter; документы кэшируются в таблице `cv`.
- Автоподборки: в `/preferences` задайте время (`HH:MM`) и часовой пояс — бот раз в день отправит новые вакансии по последнему поисковому запросу. `/vacancy_schedule` покажет текущие настройки, `/vacancy_schedule_test` отправит тестовую подборку.

## Заметки по разработке

- Стек: aiogram 3, APScheduler, SQLAlchemy 2 (async), httpx, openai, loguru, pydantic. Форматирование/линт: Ruff + Black (`pyproject.toml`).
- Переводы лежат в `i18n/`, промпты для LLM — в `prompts/` (без ключей).
- Логи пишутся в `logs/`; директория создаётся при старте.
- Планировщик запускается вместе с ботом, джоб обновляет подборки каждую минуту.
- В проде при `ENV=prod` бот работает через webhook (`WEBHOOK_URL` + `WEBHOOK_SECRET`); в dev/stage используется polling.
- При работе с ключами и токенами используйте переменные окружения и не вставляйте реальные значения в код или README.
